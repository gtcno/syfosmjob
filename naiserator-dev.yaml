apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: syfosmjob
  namespace: syfosm
  labels:
    team: teamsykefravr
spec:
  schedule: "0-59/5 * * * *"
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 100
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: syfosmjob
              image: {{ image }}
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "1000m"
                limits:
                  memory: "256Mi"
                  cpu: "1000m"
              env:
                - name: SYFOSMREGISTER_DB_URL
                  value: "jdbc:postgresql://B27DBVL003.preprod.local:5432/syfosmregister"
                - name: MOUNT_PATH_VAULT
                  value: "/postgresql/preprod-fss"
                - name: PROMETHEUS_PUSH_GATEWAY_URL
                  value: "http://nais-prometheus-prometheus-pushgateway.nais:9091"
          imagePullSecrets:
            - name: gpr-credentials
              volumeMounts:
                - mountPath: /etc/ssl/certs/ca-certificates.crt
                  name: ca-bundle
                  subPath: ca-bundle.pem
                - mountPath: /etc/pki/tls/certs/ca-bundle.crt
                  name: ca-bundle
                  subPath: ca-bundle.pem
                - mountPath: /etc/ssl/ca-bundle.pem
                  name: ca-bundle
                  subPath: ca-bundle.pem
                - mountPath: /etc/pki/tls/cacert.pem
                  name: ca-bundle
                  subPath: ca-bundle.pem
                - mountPath: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
                  name: ca-bundle
                  subPath: ca-bundle.pem
                - mountPath: /etc/ssl/certs/java/cacerts
                  name: ca-bundle
                  subPath: ca-bundle.jks
                - mountPath: /var/run/secrets/nais.io/vault
                  name: vault-secrets
          initContainers:
          - args:
            - -v=10
            - -logtostderr
            - -vault=https://vault.adeo.no
            - -one-shot
            - -cn=secret:kv/preprod/fss/syfosmjob/default:dir=/var/run/secrets/nais.io/vault,fmt=flatten
            - -save-token=/var/run/secrets/nais.io/vault/vault_token
            env:
              - name: VKS_VAULT_ADDR
                value: https://vault.adeo.no
              - name: VKS_AUTH_PATH
                value: /kubernetes/preprod/fss
              - name: VKS_KV_PATH
                value: /kv/preprod/fss/syfosmjob/syfosmjob
              - name: VKS_VAULT_ROLE
                value: syfosmjob
              - name: VKS_SECRET_DEST_PATH
                value: /var/run/secrets/nais.io/vault
              - name: VAULT_AUTH_METHOD
                value: kubernetes
              - name: VAULT_SIDEKICK_ROLE
                value: syfosmjob
              - name: VAULT_K8S_LOGIN_PATH
                value: auth/kubernetes/preprod/fss/login
            image: navikt/vks:29
            resources:
              requests:
                memory: "64Mi"
                cpu: "100m"
              limits:
                memory: "128Mi"
                cpu: "100m"
            name: vks
            volumeMounts:
            - mountPath: /var/run/secrets/nais.io/vault
              name: vault-volume
              subPath: subpath/var/run/secrets/nais.io/vault
        serviceAccount: podcreator
        serviceAccountName: podcreator
        volumes:
          - configMap:
              defaultMode: 420
              name: ca-bundle
            name: ca-bundle
          - emptyDir:
              medium: Memory
            name: vault-secrets
      backoffLimit: 4